<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Афіша</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    <div class="block block-1">
        <h1>Cinema Poster</h1>
        <h2>Перегляд афіші</h2>
    </div>

    <div class="block block-2">
        <h3>Інфо</h3>
        <p>
            Тут показано всі додані сеанси у вигляді <b>Collapse</b>.<br>
        </p>
    </div>

    <div class="block block-3">
        <h3>Меню</h3>
        <ul>
            <li><a href="index.html">Додати фільм</a></li>
            <li><a href="index2.html">Переглянути афішу</a></li>
        </ul>
    </div>

    <div class="block block-4">
        <h3>Сьогодні у кіно</h3>
        <div id="movies-container" class="collapse-container"></div>
    </div>

    <div class="block block-5">
        <h3>Управління</h3>
        <!-- Очистка списку через синхронний POST з редіректом назад -->
        <form action="server.php" method="POST">
            <input type="hidden" name="clear" value="1">
            <button type="submit" class="btn btn-danger" style="width: 100%;">Очистити список</button>
        </form>
    </div>

    <div class="block block-6"><h2>Promo</h2></div>
    <div class="block block-7"><h3>2025</h3></div>
</div>

<script>
function loadMovies() {
    // Math.random() + cache: 'no-store' — проти кешу InfinityFree
    fetch("movies.json?rand=" + Math.random(), { cache: "no-store" })
        .then(response => {
            if (!response.ok) {
                throw new Error("Не вдалося завантажити movies.json");
            }
            return response.json();
        })
        .then(showMovies)
        .catch(error => {
            console.error(error);
            document.getElementById("movies-container").innerHTML = "<p>Афіша пуста або файл відсутній.</p>";
        });
}

function showMovies(data) {
    const container = document.getElementById("movies-container");
    container.innerHTML = "";

    if (!Array.isArray(data) || data.length === 0) {
        container.innerHTML = "<p>Афіша пуста.</p>";
        return;
    }

    data.forEach(movie => {
        const item = document.createElement("div");
        item.className = "collapse-item";

        const safeTitle = movie.title || "Без назви";
        const safeContent = (movie.content || "").replace(/\n/g, "<br>");

        item.innerHTML = `
            <button class="collapse-btn">${safeTitle}</button>
            <div class="collapse-content">
                <div class="collapse-inner">${safeContent}</div>
            </div>
        `;

        container.appendChild(item);
    });

    addCollapseListeners();
}

function addCollapseListeners() {
    const buttons = document.getElementsByClassName("collapse-btn");
    for (let i = 0; i < buttons.length; i++) {
        buttons[i].onclick = function() {
            this.classList.toggle("active");
            const content = this.nextElementSibling;
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
            }
        };
    }
}

// Початкове завантаження
loadMovies();
// Періодичне асинхронне оновлення кожні 5 секунд
setInterval(loadMovies, 5000);
</script>

</body>
</html>
